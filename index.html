<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>どこでもドア Lite v3.6</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, set, update, remove, get, child, query, orderByKey, startAt, onChildAdded, onChildChanged, onChildRemoved, onDisconnect, serverTimestamp }
            from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ▼▼▼ Firebase Config (ここを書き換えてください) ▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSyAXNoSjASe1vBE_T_vgvOdmSiHXwePkbFE",
            authDomain: "dokodemodoor-1a030.firebaseapp.com",
            databaseURL: "https://dokodemodoor-1a030-default-rtdb.firebaseio.com",
            projectId: "dokodemodoor-1a030",
            storageBucket: "dokodemodoor-1a030.firebasestorage.app",
            messagingSenderId: "866685137232",
            appId: "1:866685137232:web:6e2568de33eefb23783c55"
        };
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db; window.dbRef = ref; window.dbPush = push; window.dbSet = set;
        window.dbUpdate = update; window.dbRemove = remove; window.dbGet = get; window.dbChild = child;
        window.dbQuery = query; window.dbOrderByKey = orderByKey; window.dbStartAt = startAt;
        window.dbOnDisconnect = onDisconnect;
        window.dbOnChildAdded = onChildAdded; window.dbOnChildChanged = onChildChanged;
        window.dbOnChildRemoved = onChildRemoved;
        window.serverTimestamp = serverTimestamp;
    </script>

    <style>
        :root {
            --bg-gradient: radial-gradient(circle at 20% 20%, #2b2d42, #1a1b26);
            --panel-bg: rgba(36, 40, 59, 0.95);
            --board-bg: #24283b;
            --text-main: #c0caf5;
            --border: #414868;
            --accent: #7aa2f7;
            --danger: #ff5555;
            --chat-bg: rgba(31, 35, 53, 0.95);
            --chat-mine: #7aa2f7;
            --chat-other: #3b4261;
            --modal-bg: #1f2335;
        }

        body.light-mode {
            --bg-gradient: radial-gradient(circle at 10% 10%, #e8f0ff, #e0d4fc, #ffe8e8, #e8faff);
            --panel-bg: rgba(255, 255, 255, 0.95);
            --board-bg: rgba(255, 255, 255, 0.6);
            --text-main: #333;
            --border: #ccc;
            --accent: #4863a0;
            --chat-bg: rgba(255, 255, 255, 0.95);
            --chat-mine: #4863a0;
            --chat-other: #f1f1f1;
            --modal-bg: #fff;
        }

        /* ★修正ポイント: 全称セレクタでのtouch-action: noneを削除し、bodyに適用 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* bodyはスクロール禁止にするが、子要素のボタン等は操作可能にする */
        body {
            background: var(--bg-gradient);
            background-size: 200% 200%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            transition: color 0.3s;
            touch-action: none;
            /* 基本はタッチ無効(ホワイトボード操作のため) */
        }

        /* ★重要: iOSでボタンや入力フォームが反応するように上書き設定 */
        button,
        input,
        textarea,
        .tool-btn,
        .login-btn,
        .close-btn-common,
        .resize-handle {
            touch-action: manipulation;
            /* タップ操作を許可 */
            cursor: pointer;
        }

        /* ツールバーやチャットはスクロール操作を許可 */
        .toolbar,
        .chat-messages {
            touch-action: pan-x pan-y;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* ログイン */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .login-box {
            background: var(--panel-bg);
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 380px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
        }

        .login-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff00cc, #3333ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            font-size: 16px;
            outline: none;
        }

        .login-btn {
            background: var(--accent);
            color: #fff;
            padding: 12px;
            border-radius: 30px;
            border: none;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            font-size: 1.1rem;
        }

        .theme-toggle-login {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 1.5rem;
            color: var(--text-main);
            background: var(--panel-bg);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* アプリ画面 */
        #app-screen {
            display: none;
            height: 100%;
            width: 100%;
            flex-direction: row;
        }

        .visible {
            display: flex !important;
        }

        /* ツールバー */
        .toolbar {
            width: 65px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 0;
            z-index: 100;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            overflow-y: auto;
            /* PC縦向き対応 */
        }

        .tool-btn {
            width: 42px;
            height: 42px;
            margin-bottom: 15px;
            border-radius: 12px;
            flex-shrink: 0;
            background: transparent;
            color: var(--text-main);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            transition: 0.2s;
            opacity: 0.7;
        }

        .tool-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .tool-btn.active {
            background: var(--accent);
            color: #fff;
            opacity: 1;
            box-shadow: 0 0 10px var(--accent);
        }

        .exit-btn {
            color: var(--danger);
            margin-top: auto;
            margin-bottom: 20px;
        }

        .settings-btn {
            margin-bottom: 10px;
        }

        #color-palette {
            display: none;
            flex-direction: column;
            gap: 8px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px;
            border-radius: 20px;
            margin-bottom: 10px;
        }

        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #fff;
            transition: transform 0.2s;
        }

        .color-dot.selected {
            transform: scale(1.3);
            border-color: var(--accent);
        }

        /* ホワイトボード */
        .main-area {
            flex-grow: 1;
            position: relative;
            background: var(--board-bg);
            overflow: hidden;
            cursor: grab;
        }

        #transform-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            transform-origin: 0 0;
            will-change: transform;
        }

        .layer-canvas {
            position: absolute;
            top: -2000px;
            left: -2000px;
            z-index: 1;
            pointer-events: none;
        }

        #objects-layer {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 3;
        }

        /* UIパーツ共通 */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 30px;
            height: 30px;
            background: var(--accent);
            border-radius: 50% 0 0 0;
            cursor: nwse-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
        }

        .text-window:hover .resize-handle,
        .image-wrapper:hover .resize-handle {
            opacity: 1;
        }

        .close-btn-common {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background: var(--danger);
            color: #fff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* テキスト */
        .text-window {
            position: absolute;
            min-width: 150px;
            min-height: 80px;
            background: var(--modal-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .text-header {
            height: 20px;
            background: var(--border);
            cursor: grab;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            /* ドラッグ用 */
        }

        .text-content {
            flex-grow: 1;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-main);
            font-size: 16px;
            resize: none;
            padding: 8px;
        }

        /* 画像 */
        .image-wrapper {
            position: absolute;
            border: 2px solid transparent;
            cursor: grab;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            touch-action: none;
            display: flex;
            flex-direction: column;
        }

        .image-wrapper:hover {
            border-color: rgba(122, 162, 247, 0.3);
        }

        .image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .resize-handle {
                opacity: 1;
            }
        }

        /* チャット */
        .chat-area {
            width: 320px;
            background: var(--chat-bg);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 100;
            color: var(--text-main);
            backdrop-filter: blur(10px);
        }

        .chat-header {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-input-box {
            padding: 10px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(0, 0, 0, 0.1);
        }

        .chat-input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
        }

        .msg {
            padding: 8px 14px;
            border-radius: 12px;
            max-width: 85%;
            font-size: 0.95rem;
            word-break: break-word;
        }

        .msg-sys {
            align-self: center;
            background: rgba(100, 100, 100, 0.3);
            color: #aaa;
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .msg-self {
            align-self: flex-end;
            background: var(--chat-mine);
            color: #fff;
        }

        .msg-other {
            align-self: flex-start;
            background: var(--chat-other);
            border: 1px solid var(--border);
        }

        .chat-media {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 5px;
        }

        /* 設定 */
        #settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--modal-bg);
            width: 90%;
            max-width: 400px;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .info-row {
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .info-val {
            font-size: 1.2rem;
            font-weight: bold;
            font-family: monospace;
        }

        /* モバイル */
        @media (max-width: 768px) {
            #app-screen {
                flex-direction: column;
            }

            /* モバイルツールバーは横スクロールさせる */
            .toolbar {
                width: 100%;
                height: 60px;
                flex-direction: row;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 0 15px;
                justify-content: space-between;
                overflow-x: auto;
                overflow-y: hidden;
            }

            .tool-btn {
                margin-bottom: 0;
                margin-right: 10px;
                width: 38px;
                height: 38px;
            }

            .exit-btn {
                margin: 0;
            }

            .chat-area {
                width: 100%;
                height: 35%;
                border-left: none;
                border-top: 1px solid var(--border);
            }

            #color-palette {
                position: absolute;
                top: 60px;
                left: 50px;
                flex-direction: row;
            }
        }
    </style>
</head>

<body>
    <!-- ログイン -->
    <div id="login-screen">
        <div class="login-box">
            <div class="login-title"><i class="fa-solid fa-door-open"></i> どこでもドア Lite</div>
            <p style="color:#aaa; font-size:0.8rem; margin:10px 0 20px;">v3.6 (iOS Fixed)</p>
            <input type="text" id="inp-name" class="login-input" placeholder="名前" maxlength="10">
            <input type="tel" id="inp-room" class="login-input" placeholder="ルームID" pattern="[0-9]*">
            <input type="password" id="inp-pass" class="login-input" placeholder="パスワード">
            <button class="login-btn" onclick="handleLogin()">スタート</button>
        </div>
        <div class="theme-toggle-login" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></div>
    </div>

    <!-- アプリ -->
    <div id="app-screen">
        <div class="toolbar">
            <button class="tool-btn active" id="btn-hand" onclick="setTool('hand')" title="移動"><i
                    class="fa-solid fa-up-down-left-right"></i></button>
            <button class="tool-btn" id="btn-pen" onclick="setTool('pen')" title="ペン"><i
                    class="fa-solid fa-pen"></i></button>
            <div id="color-palette">
                <div class="color-dot" style="background:#000000;" onclick="setPenColor('#000000')"></div>
                <div class="color-dot" style="background:#ffffff;" onclick="setPenColor('#ffffff')"></div>
                <div class="color-dot" style="background:#ff0000;" onclick="setPenColor('#ff0000')"></div>
                <div class="color-dot" style="background:#0000ff;" onclick="setPenColor('#0000ff')"></div>
                <div class="color-dot" style="background:#008000;" onclick="setPenColor('#008000')"></div>
                <div class="color-dot" style="background:#ffff00;" onclick="setPenColor('#ffff00')"></div>
            </div>
            <button class="tool-btn" id="btn-eraser" onclick="setTool('eraser')" title="消しゴム"><i
                    class="fa-solid fa-eraser"></i></button>
            <button class="tool-btn" id="btn-text" onclick="setTool('text')" title="テキスト"><i
                    class="fa-solid fa-font"></i></button>
            <button class="tool-btn" onclick="document.getElementById('board-img-upload').click()" title="画像"><i
                    class="fa-regular fa-image"></i></button>
            <input type="file" id="board-img-upload" hidden accept="image/*" onchange="uploadBoardImage(this)">
            <button class="tool-btn settings-btn" onclick="openSettings()" title="設定"><i
                    class="fa-solid fa-gear"></i></button>
            <div style="flex-grow:1; min-width:10px;"></div>
            <button class="tool-btn exit-btn" onclick="exitRoom()" title="退出"><i
                    class="fa-solid fa-right-from-bracket"></i></button>
        </div>

        <div class="main-area" id="main-area">
            <div id="transform-layer">
                <canvas id="bg-canvas" class="layer-canvas"></canvas>
                <div id="objects-layer"></div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header"><i class="fa-regular fa-comments"></i> チャット</div>
            <div class="chat-messages" id="chat-box"></div>
            <div class="chat-input-box">
                <label for="chat-file" style="cursor:pointer; color:var(--accent); font-size:1.2rem;"><i
                        class="fa-solid fa-paperclip"></i></label>
                <input type="file" id="chat-file" hidden accept="image/*,video/*,audio/*" onchange="sendChatFile(this)">
                <input type="text" id="chat-input" class="chat-input" placeholder="メッセージ..." autocomplete="off">
                <button class="tool-btn"
                    style="width:35px; height:35px; margin:0; background:var(--accent); color:white; border-radius:50%;"
                    onclick="sendChat()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- 設定 -->
    <div id="settings-modal" onclick="if(event.target===this) closeSettings()">
        <div class="modal-content">
            <h3><i class="fa-solid fa-gear"></i> 設定</h3>
            <div class="info-row"><span style="color:#888">ルームID</span><br><span class="info-val"
                    id="set-room-id"></span></div>
            <div class="info-row"><span style="color:#888">パスワード</span><br><span class="info-val"
                    id="set-room-pass"></span></div>
            <div style="margin-top:20px;">
                <button class="tool-btn" style="background:var(--border); width:auto; padding:0 20px;"
                    onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i> テーマ切替</button>
            </div>
            <button class="login-btn" style="margin-top:20px; width:auto; padding:10px 30px;"
                onclick="closeSettings()">閉じる</button>
        </div>
    </div>

    <script>
        const state = { name: '', room: '', pass: '', uid: 'u_' + Date.now().toString(36), tool: 'hand', color: '#000000', scale: 1, panX: 0, panY: 0, lastDraw: null };
        const mainArea = document.getElementById('main-area');
        const tfLayer = document.getElementById('transform-layer');
        const bgCanvas = document.getElementById('bg-canvas');
        const bgCtx = bgCanvas.getContext('2d');
        const objLayer = document.getElementById('objects-layer');

        window.onload = () => {
            bgCanvas.width = 4000; bgCanvas.height = 4000;
            bgCtx.translate(2000, 2000);
            state.panX = window.innerWidth / 2;
            state.panY = window.innerHeight / 2;
            updateTransform();
            document.getElementById('chat-input').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.isComposing) sendChat(); });
            checkThemeColor();
        };

        function updateTransform() { tfLayer.style.transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.scale})`; }
        function toggleTheme() { document.body.classList.toggle('light-mode'); checkThemeColor(); }
        function checkThemeColor() {
            if (document.body.classList.contains('light-mode')) { if (state.color === '#ffffff') setPenColor('#000000'); }
            else { if (state.color === '#000000') setPenColor('#ffffff'); }
        }

        async function handleLogin() {
            const name = document.getElementById('inp-name').value.trim();
            const room = document.getElementById('inp-room').value.trim();
            const pass = document.getElementById('inp-pass').value.trim();
            if (!name || !room || !pass) return alert('全ての項目を入力してください');
            const btn = document.querySelector('.login-btn');
            btn.disabled = true; btn.textContent = "接続中...";
            const roomRef = window.dbRef(window.db, `rooms/${room}`);
            try {
                const snap = await window.dbGet(roomRef);
                if (snap.exists()) {
                    const con = await window.dbGet(window.dbChild(roomRef, 'connections'));
                    if (!con.exists() || con.size === 0) { await window.dbRemove(roomRef); await createRoom(room, pass); enter(name, room, pass); }
                    else if (snap.val().meta.password === pass) enter(name, room, pass);
                    else { alert('パスワードが違います'); btn.disabled = false; btn.textContent = "スタート"; }
                } else { await createRoom(room, pass); enter(name, room, pass); }
            } catch (e) { alert('接続エラー'); btn.disabled = false; }
        }
        async function createRoom(r, p) { await window.dbSet(window.dbRef(window.db, `rooms/${r}/meta`), { password: p, createdAt: window.serverTimestamp() }); }
        function enter(n, r, p) {
            state.name = n; state.room = r; state.pass = p;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').classList.add('visible');
            const con = window.dbRef(window.db, `rooms/${r}/connections/${state.uid}`);
            window.dbSet(con, true); window.dbOnDisconnect(con).remove();
            state.panX = window.innerWidth / 2; state.panY = window.innerHeight / 2; updateTransform();
            initListeners();
        }
        async function exitRoom() {
            if (confirm("退出しますか？")) {
                await window.dbPush(window.dbRef(window.db, `rooms/${state.room}/chat`), { name: "System", text: `${state.name} が退出しました`, type: "sys" });
                const rRef = window.dbRef(window.db, `rooms/${state.room}`);
                const snap = await window.dbGet(window.dbChild(rRef, 'connections'));
                if (snap.size <= 1) await window.dbRemove(rRef); else await window.dbRemove(window.dbRef(window.db, `rooms/${state.room}/connections/${state.uid}`));
                location.reload();
            }
        }

        function initListeners() {
            const rRef = `rooms/${state.room}`;
            const chatRef = window.dbRef(window.db, rRef + '/chat');
            const startKey = window.dbPush(chatRef).key;
            window.dbSet(window.dbRef(window.db, rRef + '/chat/' + startKey), { name: "System", text: `${state.name} が入室しました`, type: "sys" });
            window.dbOnDisconnect(window.dbPush(chatRef)).set({ name: "System", text: `${state.name} (切断)`, type: "sys" });
            const q = window.dbQuery(chatRef, window.dbOrderByKey(), window.dbStartAt(startKey));
            window.dbOnChildAdded(q, s => renderChat(s.val()));
            window.dbOnChildAdded(window.dbRef(window.db, rRef + '/draw'), s => drawLocal(s.val()));
            window.dbOnChildAdded(window.dbRef(window.db, rRef + '/texts'), s => renderText(s.key, s.val()));
            window.dbOnChildChanged(window.dbRef(window.db, rRef + '/texts'), s => renderText(s.key, s.val()));
            window.dbOnChildRemoved(window.dbRef(window.db, rRef + '/texts'), s => { const el = document.getElementById('text-' + s.key); if (el) el.remove(); });
            window.dbOnChildAdded(window.dbRef(window.db, rRef + '/images'), s => renderImage(s.key, s.val()));
            window.dbOnChildChanged(window.dbRef(window.db, rRef + '/images'), s => renderImage(s.key, s.val()));
            window.dbOnChildRemoved(window.dbRef(window.db, rRef + '/images'), s => { const el = document.getElementById('img-wrap-' + s.key); if (el) el.remove(); });
            window.dbOnChildRemoved(window.dbRef(window.db, 'rooms'), s => { if (s.key === state.room) { alert("部屋が削除されました"); location.reload(); } });
        }

        /* 描画 */
        let isDrag = false;
        mainArea.addEventListener('pointerdown', e => {
            if (e.target.closest('.text-window') || e.target.closest('.image-wrapper')) return;
            if (state.tool === 'text') { const w = getPos(e.clientX, e.clientY); createText(w.x, w.y); setTool('hand'); return; }
            isDrag = true; mainArea.setPointerCapture(e.pointerId);
            if (state.tool === 'pen' || state.tool === 'eraser') state.lastDraw = getPos(e.clientX, e.clientY);
        });
        mainArea.addEventListener('pointermove', e => {
            if (!isDrag) return; e.preventDefault();
            if (state.tool === 'hand') { state.panX += e.movementX; state.panY += e.movementY; updateTransform(); }
            else {
                const w = getPos(e.clientX, e.clientY);
                if (Math.abs(w.x - state.lastDraw.x) < 2 && Math.abs(w.y - state.lastDraw.y) < 2) return;
                const mode = state.tool === 'eraser' ? 'erase' : 'draw';
                const d = { x0: state.lastDraw.x, y0: state.lastDraw.y, x1: w.x, y1: w.y, color: state.color, width: state.tool === 'eraser' ? 30 : 3, mode: mode };
                drawLocal(d); window.dbPush(window.dbRef(window.db, `rooms/${state.room}/draw`), d); state.lastDraw = w;
            }
        });
        mainArea.addEventListener('pointerup', () => isDrag = false);
        mainArea.addEventListener('wheel', e => { e.preventDefault(); zoom(Math.exp(-e.deltaY * 0.001), e.clientX, e.clientY); }, { passive: false });
        let lastDist = 0;
        mainArea.addEventListener('touchstart', e => { if (e.touches.length === 2) { isDrag = false; lastDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); } }, { passive: false });
        mainArea.addEventListener('touchmove', e => { if (e.touches.length === 2) { e.preventDefault(); const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); if (lastDist > 0) zoom(d / lastDist, (e.touches[0].clientX + e.touches[1].clientX) / 2, (e.touches[0].clientY + e.touches[1].clientY) / 2); lastDist = d; } }, { passive: false });

        function getPos(cx, cy) { const r = mainArea.getBoundingClientRect(); return { x: (cx - r.left - state.panX) / state.scale, y: (cy - r.top - state.panY) / state.scale }; }
        function zoom(f, cx, cy) { const s = Math.max(0.1, Math.min(5, state.scale * f)); const r = mainArea.getBoundingClientRect(); state.panX = (cx - r.left) - (cx - r.left - state.panX) * (s / state.scale); state.panY = (cy - r.top) - (cy - r.top - state.panY) * (s / state.scale); state.scale = s; updateTransform(); }

        function drawLocal(d) {
            bgCtx.save(); bgCtx.beginPath(); bgCtx.moveTo(d.x0, d.y0); bgCtx.lineTo(d.x1, d.y1);
            if (d.mode === 'erase') { bgCtx.globalCompositeOperation = 'destination-out'; bgCtx.strokeStyle = 'rgba(0,0,0,1)'; }
            else { bgCtx.globalCompositeOperation = 'source-over'; bgCtx.strokeStyle = d.color; }
            bgCtx.lineWidth = d.width; bgCtx.lineCap = 'round'; bgCtx.lineJoin = 'round'; bgCtx.stroke(); bgCtx.restore();
        }
        window.setTool = (t) => { state.tool = t; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-' + t).classList.add('active'); document.getElementById('color-palette').style.display = (t === 'pen') ? 'flex' : 'none'; mainArea.style.cursor = (t === 'hand') ? 'grab' : (t === 'text' ? 'text' : 'crosshair'); };
        window.setPenColor = (c) => { state.color = c; document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('selected', d.style.backgroundColor === c || (c === '#ffffff' && d.style.backgroundColor === 'rgb(255, 255, 255)') || (c === '#000000' && d.style.backgroundColor === 'rgb(0, 0, 0)'))); if (state.tool !== 'pen') setTool('pen'); };

        /* テキスト */
        function createText(x, y) { window.dbPush(window.dbRef(window.db, `rooms/${state.room}/texts`), { x, y, text: '', w: 200, h: 100 }); }
        function renderText(key, d) {
            let el = document.getElementById('text-' + key);
            if (!el) {
                el = document.createElement('div'); el.id = 'text-' + key; el.className = 'text-window';
                el.innerHTML = `<div class="text-header"></div><div class="close-btn-common">×</div><textarea class="text-content"></textarea><div class="resize-handle">⤡</div>`;
                objLayer.appendChild(el);

                const head = el.querySelector('.text-header');
                const close = el.querySelector('.close-btn-common');
                const ta = el.querySelector('textarea');
                const res = el.querySelector('.resize-handle');

                close.onclick = e => { e.stopPropagation(); if (confirm('削除？')) window.dbRemove(window.dbRef(window.db, `rooms/${state.room}/texts/${key}`)); };
                ta.oninput = () => window.dbUpdate(window.dbRef(window.db, `rooms/${state.room}/texts/${key}`), { text: ta.value });
                el.onmousedown = () => el.style.zIndex = 100;

                setupDrag(head, el, (nx, ny) => window.dbUpdate(window.dbRef(window.db, `rooms/${state.room}/texts/${key}`), { x: nx, y: ny }));
                setupResize(res, el, (nw, nh) => window.dbUpdate(window.dbRef(window.db, `rooms/${state.room}/texts/${key}`), { w: nw, h: nh }));
            }
            el.style.left = d.x + 'px'; el.style.top = d.y + 'px'; el.style.width = (d.w || 200) + 'px'; el.style.height = (d.h || 100) + 'px';
            const ta = el.querySelector('textarea'); if (document.activeElement !== ta) ta.value = d.text || '';
        }

        /* 画像 */
        window.uploadBoardImage = (input) => {
            if (input.files[0]) {
                if (input.files[0].size > 3 * 1024 * 1024) return alert('3MB以下にしてください');
                const r = new FileReader(); r.onload = e => { const w = getPos(window.innerWidth / 2, window.innerHeight / 2); window.dbPush(window.dbRef(window.db, `rooms/${state.room}/images`), { x: w.x, y: w.y, width: 200, height: 200, src: e.target.result }); }; r.readAsDataURL(input.files[0]); input.value = '';
            }
        };
        function renderImage(key, d) {
            let el = document.getElementById('img-wrap-' + key);
            if (!el) {
                el = document.createElement('div'); el.id = 'img-wrap-' + key; el.className = 'image-wrapper';
                el.innerHTML = `<img src="${d.src}"><div class="close-btn-common">×</div><div class="resize-handle">⤡</div>`;
                objLayer.appendChild(el);

                const close = el.querySelector('.close-btn-common');
                close.onclick = e => { e.stopPropagation(); if (confirm('削除？')) window.dbRemove(window.dbRef(window.db, `rooms/${state.room}/images/${key}`)); };
                el.ondblclick = e => { e.stopPropagation(); if (confirm('削除？')) window.dbRemove(window.dbRef(window.db, `rooms/${state.room}/images/${key}`)); };

                setupDrag(el, el, (nx, ny) => window.dbUpdate(window.dbRef(window.db, `rooms/${state.room}/images/${key}`), { x: nx, y: ny }));
                setupResize(el.querySelector('.resize-handle'), el, (nw, nh) => window.dbUpdate(window.dbRef(window.db, `rooms/${state.room}/images/${key}`), { width: nw, height: nh }));
            }
            el.style.left = d.x + 'px'; el.style.top = d.y + 'px'; el.style.width = (d.width || 200) + 'px'; el.style.height = (d.height || 200) + 'px';
        }

        function setupDrag(handle, target, onEnd) {
            let isD = false, sx, sy;
            handle.onpointerdown = e => {
                if (e.target.closest('.close-btn-common') || e.target.closest('.resize-handle')) return;
                e.preventDefault(); isD = true; handle.setPointerCapture(e.pointerId);
                const r = target.getBoundingClientRect(); sx = e.clientX - r.left; sy = e.clientY - r.top; e.stopPropagation();
            };
            handle.onpointermove = e => {
                if (!isD) return; const r = mainArea.getBoundingClientRect();
                target.style.left = ((e.clientX - r.left - state.panX) / state.scale - sx / state.scale) + 'px';
                target.style.top = ((e.clientY - r.top - state.panY) / state.scale - sy / state.scale) + 'px';
            };
            handle.onpointerup = () => { if (isD) { isD = false; onEnd(parseFloat(target.style.left), parseFloat(target.style.top)); } };
        }

        function setupResize(handle, target, onEnd) {
            let isR = false, lr = { x: 0, y: 0 };
            handle.onpointerdown = e => { e.stopPropagation(); e.preventDefault(); isR = true; lr = { x: e.clientX, y: e.clientY }; handle.setPointerCapture(e.pointerId); };
            handle.onpointermove = e => { if (!isR) return; const dx = (e.clientX - lr.x) / state.scale, dy = (e.clientY - lr.y) / state.scale; target.style.width = Math.max(50, parseFloat(target.style.width) + dx) + 'px'; target.style.height = Math.max(50, parseFloat(target.style.height) + dy) + 'px'; lr = { x: e.clientX, y: e.clientY }; };
            handle.onpointerup = () => { if (isR) { isR = false; onEnd(parseFloat(target.style.width), parseFloat(target.style.height)); } };
        }

        /* チャット */
        window.sendChat = () => { const i = document.getElementById('chat-input'); if (i.value.trim()) window.dbPush(window.dbRef(window.db, `rooms/${state.room}/chat`), { name: state.name, text: i.value.trim(), type: 'user', timestamp: window.serverTimestamp() }); i.value = ''; };
        window.sendChatFile = i => {
            if (i.files[0]) {
                if (i.files[0].size > 3 * 1024 * 1024) return alert('3MB以下にしてください');
                const r = new FileReader(); r.onload = e => {
                    let type = 'image'; if (i.files[0].type.startsWith('video')) type = 'video'; else if (i.files[0].type.startsWith('audio')) type = 'audio';
                    window.dbPush(window.dbRef(window.db, `rooms/${state.room}/chat`), { name: state.name, media: e.target.result, mediaType: type, type: 'user', timestamp: window.serverTimestamp() });
                }; r.readAsDataURL(i.files[0]); i.value = '';
            }
        };
        function renderChat(v) {
            const b = document.getElementById('chat-box'), d = document.createElement('div');
            if (v.type === 'sys') { d.className = 'msg msg-sys'; d.textContent = v.text; }
            else {
                d.className = `msg ${v.name === state.name ? 'msg-self' : 'msg-other'}`;
                let c = `<div style="font-size:0.7rem;opacity:0.7;">${escapeHtml(v.name)}</div>`;
                if (v.text) c += escapeHtml(v.text);
                if (v.media) {
                    if (v.mediaType === 'image') c += `<img src="${v.media}" class="chat-media">`;
                    else if (v.mediaType === 'video') c += `<video src="${v.media}" controls class="chat-media"></video>`;
                    else if (v.mediaType === 'audio') c += `<audio src="${v.media}" controls style="max-width:100%; margin-top:5px;"></audio>`;
                }
                d.innerHTML = c;
            }
            b.appendChild(d); b.scrollTop = b.scrollHeight;
        }

        window.openSettings = () => { document.getElementById('set-room-id').textContent = state.room; document.getElementById('set-room-pass').textContent = state.pass; document.getElementById('settings-modal').style.display = 'flex'; };
        window.closeSettings = () => { document.getElementById('settings-modal').style.display = 'none'; };
        function escapeHtml(s) { return s ? s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])) : ''; }
    </script>
</body>

</html>